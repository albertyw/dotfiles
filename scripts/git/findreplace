#!/bin/bash

set -euo pipefail
IFS=$'\n\t'

location=${GIT_PREFIX:-./}
search="$1"
escaped_search=$(printf '%s\n' "$search" | sed -e 's/[]\/$*.^[]/\\&/g');
replace="$2"
escaped_replace=$(printf '%s\n' "$replace" | sed -e 's/[]\/$*.^[]/\\&/g');

sed2() {
    file="$1"
    echo "$file"
    if [[ $(uname) == Darwin ]]; then
        sed -i '' -e "s/$escaped_search/$escaped_replace/g" "$file"
    else
        sed -i -e "s/$escaped_search/$escaped_replace/g" "$file"
    fi
}

files="$(git grep -l "$search" "$location")"
for file in $files; do
    sed2 "$file"
done
